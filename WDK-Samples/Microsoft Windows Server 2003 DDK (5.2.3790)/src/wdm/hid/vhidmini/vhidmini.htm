<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0118)file://C:\Documents%20and%20Settings\kumar\Local%20Settings\Temporary%20Internet%20Files\OLK7F8B\Sample_Template2.html -->
<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns:x="urn:schemas-microsoft-com:office:excel"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 10">
<meta name=Originator content="Microsoft Word 10">
<link rel=File-List href="vhidmini_files/filelist.xml">
<title>Sample</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>Kumar Rajeev</o:Author>
  <o:LastAuthor>Kumar Rajeev</o:LastAuthor>
  <o:Revision>59</o:Revision>
  <o:TotalTime>683</o:TotalTime>
  <o:Created>2002-07-08T21:54:00Z</o:Created>
  <o:LastSaved>2002-08-23T19:43:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>1961</o:Words>
  <o:Characters>11182</o:Characters>
  <o:Company>Microsoft Corporation</o:Company>
  <o:Lines>93</o:Lines>
  <o:Paragraphs>26</o:Paragraphs>
  <o:CharactersWithSpaces>13117</o:CharactersWithSpaces>
  <o:Version>10.3501</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:Zoom>90</w:Zoom>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Verdana;
	panose-1:2 11 6 4 3 5 4 4 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:536871559 0 0 0 415 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";}
h2
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	mso-outline-level:2;
	font-size:18.0pt;
	font-family:"Times New Roman";
	font-weight:bold;}
h3
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	mso-outline-level:3;
	font-size:13.5pt;
	font-family:"Times New Roman";
	font-weight:bold;}
h4
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	mso-outline-level:4;
	font-size:12.0pt;
	font-family:"Times New Roman";
	font-weight:bold;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;
	text-underline:single;}
p
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
span.GramE
	{mso-style-name:"";
	mso-gram-e:yes;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
 /* List Definitions */
 @list l0
	{mso-list-id:403649173;
	mso-list-type:hybrid;
	mso-list-template-ids:-1862108902 67698703 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l0:level1
	{mso-level-tab-stop:.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l0:level2
	{mso-level-tab-stop:1.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l0:level3
	{mso-level-tab-stop:1.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l0:level4
	{mso-level-tab-stop:2.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l0:level5
	{mso-level-tab-stop:2.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l0:level6
	{mso-level-tab-stop:3.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l0:level7
	{mso-level-tab-stop:3.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l0:level8
	{mso-level-tab-stop:4.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l0:level9
	{mso-level-tab-stop:4.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l1
	{mso-list-id:473184148;
	mso-list-template-ids:-1351318452;}
@list l1:level1
	{mso-level-tab-stop:.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l1:level2
	{mso-level-tab-stop:1.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l1:level3
	{mso-level-tab-stop:1.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l1:level4
	{mso-level-tab-stop:2.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l1:level5
	{mso-level-tab-stop:2.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l1:level6
	{mso-level-tab-stop:3.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l1:level7
	{mso-level-tab-stop:3.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l1:level8
	{mso-level-tab-stop:4.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l1:level9
	{mso-level-tab-stop:4.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l2
	{mso-list-id:505704747;
	mso-list-type:hybrid;
	mso-list-template-ids:2087346806 67698703 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l2:level1
	{mso-level-tab-stop:.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l2:level2
	{mso-level-tab-stop:1.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l2:level3
	{mso-level-tab-stop:1.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l2:level4
	{mso-level-tab-stop:2.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l2:level5
	{mso-level-tab-stop:2.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l2:level6
	{mso-level-tab-stop:3.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l2:level7
	{mso-level-tab-stop:3.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l2:level8
	{mso-level-tab-stop:4.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l2:level9
	{mso-level-tab-stop:4.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l3
	{mso-list-id:1749107583;
	mso-list-template-ids:-1351318452;}
@list l4
	{mso-list-id:1939633541;
	mso-list-type:hybrid;
	mso-list-template-ids:-1997396706 67698703 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l4:level1
	{mso-level-tab-stop:.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l4:level2
	{mso-level-tab-stop:1.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l4:level3
	{mso-level-tab-stop:1.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l4:level4
	{mso-level-tab-stop:2.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l4:level5
	{mso-level-tab-stop:2.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l4:level6
	{mso-level-tab-stop:3.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l4:level7
	{mso-level-tab-stop:3.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l4:level8
	{mso-level-tab-stop:4.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l4:level9
	{mso-level-tab-stop:4.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
ol
	{margin-bottom:0in;}
ul
	{margin-bottom:0in;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";}
</style>
<![endif]-->
</head>

<body lang=EN-US link=blue vlink=purple style='tab-interval:.5in'>

<div class=Section1>

<h2><span style='font-family:Verdana'>VHIDMINI<o:p></o:p></span></h2>

<h3><span style='font-family:Verdana'>SUMMARY<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>Vhidmini.sys is a sample
HID minidriver written with a purpose to demonstrate the following:<o:p></o:p></span></p>

<p style='margin-left:.5in;text-indent:-.25in;mso-list:l0 level1 lfo2;
tab-stops:list .5in'><![if !supportLists]><span style='font-family:Verdana;
mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana'><span
style='mso-list:Ignore'>1.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana'>How
to communicate with a HID minidriver from a HID client using a custom feature
item in order to control certain features of the HID minidriver. This is needed
since other conventional modes for communicating with a driver like custom
IOCTL or WMI do not work with HID minidriver. </span><span style='font-family:
Verdana'><o:p></o:p></span></p>

<p style='margin-left:.5in;text-indent:-.25in;mso-list:l0 level1 lfo2;
tab-stops:list .5in'><![if !supportLists]><span style='font-family:Verdana;
mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana'><span
style='mso-list:Ignore'>2.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana'>Test
a HID report descriptor without using a physical device. </span><span
style='font-family:Verdana'><o:p></o:p></span></p>

<p style='margin-left:.5in;text-indent:-.25in;mso-list:l0 level1 lfo2;
tab-stops:list .5in'><![if !supportLists]><span style='font-family:Verdana;
mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana'><span
style='mso-list:Ignore'>3.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana'>Structure
of a HID minidriver and handling of internal IOCTLs sent by the <span
class=SpellE>HIDclass</span> driver. </span><span style='font-family:Verdana'><o:p></o:p></span></p>

<h4><span style='font-family:Verdana'>Introduction to HID Minidriver<o:p></o:p></span></h4>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>A
driver registers itself to be a HID minidriver by calling the API <span
class=SpellE><span class=GramE>HIDRegisterMinidriver</span></span><span
class=GramE>(</span>) in its DriverEntry() routine and passing the
HID_MINIDRIVER_REGISTRATION structure as an argument (after filling this
structure with necessary information). As a result of calling this API, the
Hidclass driver (<span class=SpellE>hidclass.sys</span>) takes charge and all
subsequent system calls to the minidriver first get handled by the Hidclass
driver. <o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>The
hidclass driver creates a device object for the HID minidriver, attaches to the
PDO and calls <span class=GramE>AddDevice(</span>) routine of the HID
minidriver passing the functional device object it created for the HID
minidriver.<span style='mso-spacerun:yes'>  </span>After the <span class=GramE>AddDevice(</span>)
returns successfully, the minidriver starts receiving PnP IRPs. In the
IRP_MN_START_DEVICE, the minidriver takes appropriate actions and sets the
state of the device. After IRP_MN_START_DEVICE completes, the HID minidriver
starts receiving internal IOCTL requests from the Hidclass driver. The internal
IOCTLs that a HID minidriver must handle are:<o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>IOCTL_HID_DEVICE_DESCRIPTOR<o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>IOCTL_HID_DEVICE_ATTRIBUTES<o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>IOCTL_HID_REPORT_DESCRIPTOR<o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>The
hidclass driver parses the report descriptor and creates a PDO corresponding to
each top-level collection declared in the report descriptor. The PnP manager
looks for appropriate function driver (HID client drivers) for these collection
<span class=SpellE>PDOs</span> and loads them if it finds a matching one.<o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>If
the Hidclass driver finds an input item in any of the collections, it starts
sending internal IOCTL request IOCTL_HID_READ_REPORT<span
style='mso-spacerun:yes'>  </span>to read input report. The Hidclass driver
sends these requests in two ways: if the device is declared as a polled device
by setting the flag “<span class=SpellE>DevicesArePolled</span>” in the
HID_MINIDRIVER_REGISTRATION structure then the class driver starts polling
process and sends IOCTL_HID_READ_REPORT report at a regular interval of time,
otherwise it sends certain number of IRPs (generally two), also called
ping-pong IRPs, to read the input report and reuses those IRPs once they are
completed. USB HID devices do not need polling at regular interval since they
use interrupt transfer to send or receive data at regular interval.<span
style='mso-spacerun:yes'>  </span>A legacy device may however need to be polled
in which case the corresponding HID mini driver has to set the <span
class=SpellE>DevicesArePolled</span> flag in the HID_MINIDRIVER_REGISTRATION
structure.<o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>The
vhidmini.sys sample minidriver has inline comments that explain the purpose of
internal IOCTLs sent by the Hidclass driver<o:p></o:p></span></h3>

<h4><span style='font-family:Verdana'>Introduction to the vhidmini.sys HID
Minidriver Sample <o:p></o:p></span></h4>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>Vhidmini.sys
is a sample HID minidriver. The sample is installed as a root-enumerated driver
using <span class=SpellE>devcon</span> utility. During installation the INF
file <span class=SpellE>vhidmini.inf</span> adds a registry entry containing
the report descriptor in the device parameters path. The driver registers
itself as a HID minidriver in the <span class=GramE>DriverEntry(</span>). In
the IRP_MN_START_DEVICE, it reads the report descriptor from the registry and
stores it in its device extension. The minidriver then reports necessary
descriptors (HID descriptor, report descriptor, device attributes etc.) to the
Hidclass driver through internal IOCTL interface. With actual USB HID devices,
these descriptors are usually burned into the device’s firmware but with this
sample driver these are hard-coded in the driver itself to simulate a HID device.<span
style='mso-spacerun:yes'>  </span>The Hidclass driver then creates one PDO
corresponding to one top-level collection declared in the report descriptor.
The PnP manager finds a hardware ID match in <span class=SpellE>vhidmini.inf</span>
file (supplied with the sample package) and installs a null service as specified
in the INF file. <o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>The
Hidclass driver finds an input item in one of the collections and therefore
starts sending ping-pong IRPs (since the HID minidriver reported the device to
be non-Polled) to read input reports using IOCTL_HID_READ_REPORT. The <span
class=SpellE><span class=GramE>ReadReport</span></span><span class=GramE>(</span>)
routine in vhidmini.sys handles this request. It allocates a timer and a DPC
structure and queues the timer DPC each time it receives a read request. The
DPC callback routine gets called when the time interval set in the timer
elapses. The callback routine copies two bytes (one byte for the report ID and
the other a random character byte) to the IRP and completes the IRP. It also
frees the timer and the DPC structures. This continues as long as the
minidriver receives read requests. This simple technique of handling read IRPs
was chosen because the goal of this minidriver was to keep the code as simple
as possible and not to confuse developers with complex queuing and cancellation
issues in handling read IRPs. <o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>The
sample also implements code to handle IOCTL_HID_GET_FEATURE and
IOCTL_HID_SET_FEATURE requests. They are explained below.<o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana'>Communicating with HID
minidriver using custom feature item:<o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>The
conventional way of communicating with a driver from a user mode application is
to use IOCTL interface or WMI interface. These methods do not work in case of
HID minidriver because the system-supplied Hidclass driver handles these for
the HID minidriver and does not allow these requests to reach the minidriver.
As a work around, this sample demonstrates the use of custom feature items to
communicate with the HID minidriver. <o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>As
explained earlier, the HID minidriver creates a virtual HID device. This
virtual HID device corresponds to one collection reported in the report
descriptor. This collection has one feature item of 1 byte dedicated for
communicating with HID clients.<span style='mso-spacerun:yes'>  </span>HID
clients obtain a handle to this collection (or virtual hid device) and use <span
class=SpellE>HidD_GetFeature</span> API (documented in the DDK) to send custom
control information to this collection. The HID minidriver receives the custom
control information through the internal IOCTL IOCTL_HID_GET_REPORT and
switches to appropriate code based on the control code (one-byte control code
is defined in a common header file so both the application and the minidriver are
aware of it).<span style='mso-spacerun:yes'>  </span><o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana'>Testing report
descriptor without using physical device:<o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>The
sample driver reads report descriptor from registry (the descriptor is written
to the registry through INF file during installation of HID minidriver). In
order to test your descriptor, you need to modify/add the report descriptor in
the registry. The report descriptor is a binary value named “<span
class=SpellE>MyReportDescriptor</span>” located under the following key in the
registry:<o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Enum\Root\HIDCLASS\&lt;instance#&gt;\Device
Parameters<o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>After
modifying, disable and re-enable the virtual HID minidriver. This will cause
the minidriver to unload and reload, this time reading the new/modified report
descriptor from the registry. If the system finds a problem with the
descriptor, it will not install the virtual HID minidriver and you will see
yellow exclamation mark in the device manager. This method makes it easy to
test a report descriptor without using an actual physical device. <o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>One
thing to remember is that, if your report descriptor declares an input item
then you need to implement code for handling IOCTL_HID_READ_REPORT. This is
because when the Hidclass driver finds a collection with an input item, it will
start polling the HID minidriver. <o:p></o:p></span></h3>

<h4><span style='font-family:Verdana'>Contents of <span class=SpellE>vhidmini</span>
sample driver folder<o:p></o:p></span></h4>

<p><span style='font-size:10.0pt;font-family:Verdana'>This sample driver
package contains <i>sys</i> and <i>exe</i> directories. The following summary
describes the directories and key files. <o:p></o:p></span></p>

<p><span class=GramE><i><span style='font-size:10.0pt;font-family:Verdana'>sys</span></i></span><span
style='font-size:10.0pt;font-family:Verdana'> <o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Verdana'>This
directory contains the source code of the virtual HID minidriver
(vhidmini.sys). <o:p></o:p></span></p>

<p><span class=GramE><i><span style='font-size:10.0pt;font-family:Verdana'>exe</span></i></span><i><span
style='font-size:10.0pt;font-family:Verdana'> <o:p></o:p></span></i></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Verdana'>This directory
contains the source code of a test application (testvHID.exe). <o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>BUILDING THE SAMPLE<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>To build the sample
driver and test application, you must first set up the DDK environment on your
host machine. The “Installation and Release Notes” in the Windows 2000/XP DDK
has a complete description on how to do this. <o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l1 level1 lfo5;tab-stops:list .5in'><span style='font-size:10.0pt;
     font-family:Verdana'>Run the build –<span class=SpellE>ceZ</span> command
     in the <span class=SpellE>vhidmini</span> directory to build vhidmini.sys
     and testvHID.exe files. <o:p></o:p></span></li>
 <li class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l1 level1 lfo5;tab-stops:list .5in'><span style='font-size:10.0pt;
     font-family:Verdana'>Copy the .sys, .exe and the INF file (<span
     class=SpellE>vhidmini.inf</span>) to a floppy disk or a temporary
     directory on the target system. <o:p></o:p></span></li>
</ol>

<h3><span style='font-family:Verdana'>INSTALLING THE SAMPLE<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>This virtual HID
minidriver sample could be installed either as a root-enumerated driver or as a
bus-enumerated driver. <o:p></o:p></span></p>

<p><b><span style='font-size:10.0pt;font-family:Verdana'>Installing as a
root-enumerated driver:<o:p></o:p></span></b></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>To install as a
root-enumerated driver, you could use a command-line utility called devcon.exe
available with the DDK in the &lt;ddk folder&gt;\tools\<span class=SpellE>devcon</span>
folder, or from the following link:<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'><a
href="http://support.microsoft.com/default.aspx?scid=kb;en-us;Q311272">http://support.microsoft.com/default.aspx?scid=kb;en-us;Q311272</a><o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>Follow these steps to
install this sample using <span class=SpellE>devcon</span> utility:<o:p></o:p></span></p>

<p style='margin-left:.5in;text-indent:-.25in;mso-list:l4 level1 lfo7;
tab-stops:list .5in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana'><span
style='mso-list:Ignore'>1.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana'>Open
a command window and change the folder to go to the temporary folder where you
copied the .sys, .exe and .inf files.<o:p></o:p></span></p>

<p style='margin-left:.5in;text-indent:-.25in;mso-list:l4 level1 lfo7;
tab-stops:list .5in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana'><span
style='mso-list:Ignore'>2.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana'>Type
the following command line. Make sure that devcon.exe is either present in the
current directory or is in the command path.<o:p></o:p></span></p>

<p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
text-indent:.5in;line-height:200%'><span style='font-size:10.0pt;line-height:
200%;font-family:Verdana'>C:\&gt;devcon <span class=GramE>install</span> <span
class=SpellE>vhidmini.inf</span>
“{D49F883C-6486-400a-8C22-1A9EF48577E4}\HID_DEVICE”<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>This will install the
vhidmini.sys driver as root-enumerated driver. Check in the Device Manager to
see if the driver is installed correctly. You will see the following entries
under “Human Interface Devices” in the Device Manager.<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>On Windows 2000, you will
see the following:<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'><span
style='mso-spacerun:yes'>             </span>&quot;Root Enumerated Virtual HID
Minidriver (sample)&quot; <o:p></o:p></span></p>

<p style='text-indent:.5in'><span style='font-size:10.0pt;font-family:Verdana'><span
style='mso-spacerun:yes'>   </span>&quot;Virtual HID Device (sample)&quot; <o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>On Windows XP, you will
see the following:<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'><span
style='mso-spacerun:yes'>             </span>&quot;Root Enumerated Virtual HID
Minidriver (sample)&quot;<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'><span
style='mso-spacerun:yes'>             </span>“HID-Compliant device”<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>The reason that you see
“HID-compliant device” under Windows XP is because of a difference in the way
the two operating systems handle unsigned drivers. Windows XP prefers a signed
INF file over an unsigned one even if the unsigned INF has a better hardware id
match. Windows 2000, on the other hand, selects the INF file with a better hardware-ID
match irrespective of the signature. In this case Windows XP finds a hardware
id match in the system-supplied <span class=SpellE>input.inf</span> file and
therefore prefers installing the driver using this INF file. If you want the
system to use your unsigned INF file then you will have to use update driver
feature. To do this, right click on “HID-Compliant device” in the device
manager and select “Update Driver…” menu option. Select “Install from a list or
specific location (Advanced)” option, <span class=GramE>then</span> select
“Don’t search. I will choose the driver to install” <span class=GramE>option,
then click on “Have Disk” and point to your INF file</span> location. When
update completes, you will see “Virtual HID Device (sample)” in the device
manager instead of “HID-Compliant device”.<o:p></o:p></span></p>

<p><b><span style='font-size:10.0pt;font-family:Verdana'>Note: </span></b><span
style='font-size:10.0pt;font-family:Verdana'>On Windows XP and Windows Server 2003, if
you reboot the system after installing this sample hid minidriver as
root-enumerated driver, you will see “Found New Hardware” balloon popping up
followed by Found New Hardware Wizard. You should just cancel the Wizard. This
happens because of a known bug in one of the system APIs and will be fixed in
the next release of OS. <b><o:p></o:p></b></span></p>

<p><b><span style='font-size:10.0pt;font-family:Verdana'>Installing as a
bus-enumerated driver:<o:p></o:p></span></b></p>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal'>You
could use Toaster bus enumerator (a bus enumerator sample supplied with Windows
DDK) to enumerate this sample. Follow these steps:<o:p></o:p></span></h3>

<h3 style='margin-left:.5in;text-indent:-.25in;mso-list:l1 level2 lfo5;
tab-stops:list .5in 1.0in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana;
font-weight:normal'><span style='mso-list:Ignore'>1.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana;
font-weight:normal'>Install toaster bus enumerator (see Toaster documentation
for any help with this).<o:p></o:p></span></h3>

<h3 style='margin-left:.5in;text-indent:-.25in;mso-list:l1 level2 lfo5;
tab-stops:list .5in 1.0in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana;
font-weight:normal'><span style='mso-list:Ignore'>2.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana;
font-weight:normal'>Run Notify.exe program (comes with Toaster sample)<o:p></o:p></span></h3>

<h3 style='margin-left:.5in;text-indent:-.25in;mso-list:l1 level2 lfo5;
tab-stops:list .5in 1.0in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana;
font-weight:normal'><span style='mso-list:Ignore'>3.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana;
font-weight:normal'>Select “<span class=SpellE>Plugin</span>” option from “Bus”
menu.<o:p></o:p></span></h3>

<h3 style='margin-left:.5in;text-indent:-.25in;mso-list:l1 level2 lfo5;
tab-stops:list .5in 1.0in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana;
font-weight:normal'><span style='mso-list:Ignore'>4.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana;
font-weight:normal'>In the “Plug <span class=GramE>In</span> Device” dialog
box, for “Device ID” enter the following hardware ID for the hid minidriver:<o:p></o:p></span></h3>

<h3 style='margin-left:.25in;text-indent:.25in'><span style='font-size:10.0pt;
font-family:Verdana;font-weight:normal'><span
style='mso-spacerun:yes'> </span>{D49F883C-6486-400a-8C22-1A9EF48577E4}\HID_DEVICE1<o:p></o:p></span></h3>

<h3 style='margin-left:.5in;text-indent:-.25in;mso-list:l1 level2 lfo5;
tab-stops:list .5in 1.0in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana;
font-weight:normal'><span style='mso-list:Ignore'>5.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana;
font-weight:normal'>Enter appropriate serial number in “Serial Number” edit box
(e.g. enter 1 if this is the first device that toaster bus is enumerating) and
click OK. <o:p></o:p></span></h3>

<h3 style='margin-left:.5in;text-indent:-.25in;mso-list:l1 level2 lfo5;
tab-stops:list .5in 1.0in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana;
font-weight:normal'><span style='mso-list:Ignore'>6.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana;
font-weight:normal'>You will see “Found New Hardware Wizard” popping up for
“Toaster Enumerated Virtual HID Minidriver (sample)&quot;. <o:p></o:p></span></h3>

<h3 style='margin-left:.5in;text-indent:-.25in;mso-list:l1 level2 lfo5;
tab-stops:list .5in 1.0in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana;
font-weight:normal'><span style='mso-list:Ignore'>7.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana;
font-weight:normal'>Select “Install from a list or specific location
(Advanced)” option.<o:p></o:p></span></h3>

<h3 style='margin-left:.5in;text-indent:-.25in;mso-list:l1 level2 lfo5;
tab-stops:list .5in 1.0in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana;
font-weight:normal'><span style='mso-list:Ignore'>8.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana;
font-weight:normal'>Select “Don’t search. <span class=GramE>I will choose the
driver to install” option.</span><span style='mso-spacerun:yes'>  </span>Click
on “Have Disk” and point to <span class=SpellE>vhidmini.inf</span> INF file
location. <o:p></o:p></span></h3>

<h3 style='margin-left:.5in;text-indent:-.25in;mso-list:l1 level2 lfo5;
tab-stops:list .5in 1.0in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana;
font-weight:normal'><span style='mso-list:Ignore'>9.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana;
font-weight:normal'>This will install the Hid minidriver.<o:p></o:p></span></h3>

<h3 style='margin-left:.5in;text-indent:-.25in;mso-list:l1 level2 lfo5;
tab-stops:list .5in 1.0in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana;
font-weight:normal'><span style='mso-list:Ignore'>10.<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana;
font-weight:normal'>You will see “Found New Hardware Wizard” popping up again,
this time for “HID-compliant device”. Repeat steps 7 and 8.<o:p></o:p></span></h3>

<h3><span style='font-family:Verdana'>RUNNING THE SAMPLE<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>Once the drivers are
installed correctly, you can use the provided application to test sending
control requests to the HID minidriver.<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>To run the test <span
class=GramE>application (testvhid.exe) do</span> the following:<o:p></o:p></span></p>

<p style='margin-left:.5in;text-indent:-.25in;mso-list:l2 level1 lfo9;
tab-stops:list .5in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana'><span
style='mso-list:Ignore'>1.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana'>Open
a command window and change the folder to go to the temporary folder where you
copied the .sys, .exe and .inf files.<o:p></o:p></span></p>

<p style='margin-left:.5in;text-indent:-.25in;mso-list:l2 level1 lfo9;
tab-stops:list .5in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana'><span
style='mso-list:Ignore'>2.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana'>Run
the following command line:<o:p></o:p></span></p>

<p style='margin-left:.5in'><span style='font-size:10.0pt;font-family:Verdana'>C:\&gt;testvhid<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>You will see device
attributes information printed in the command window. The test application sent
a control code HIDMINI_CONTROL_CODE_GET_ATTRIBUTES using <span class=SpellE>HidD_<span
class=GramE>GetFeature</span></span><span class=GramE>(</span>) to get the
device attributes information from the minidriver and printed it in the command
window. <o:p></o:p></span></p>

</div>

</body>

</html>
